#!/bin/bash
default_conf() {
    if [ ! -f "$SNAP_DATA"/etc/fwupd.conf ]
    then
            mkdir -p "$SNAP_DATA/etc"
            cp "$SNAP/etc/fwupd.conf" "$SNAP_DATA/etc/fwupd.conf"
    fi

    if [ ! -d $SNAP_DATA/etc/pki ]
    then
            cp -r $SNAP/etc/pki $SNAP_DATA/etc/
    fi
}

default_conf

value=$(snapctl get conf.downloaduri)
if [ -n "$value" ]; then
	cp $SNAP_DATA/etc/fwupd.conf $SNAP_DATA/etc/fwupd.conf.bak
	sed "s>DownloadURI=.*>DownloadURI=$value>" "$SNAP_DATA/etc/fwupd.conf.bak" > "$SNAP_DATA/etc/fwupd.conf"
	rm "$SNAP_DATA/etc/fwupd.conf.bak"
else
	#setup default conf.downloaduri from the default fwupd.conf
	snapctl set conf.downloaduri=$(sed -n "s/DownloadURI=\(.*\)/\1/p" $SNAP/etc/fwupd.conf)
fi
